version: '3.8'

services:
  resource-monitor:
    build: .
    container_name: resource-monitor
    restart: unless-stopped
    # Required for accurate system metrics
    privileged: true
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    environment:
      - TZ=${TZ:-UTC}
      # Telegram configuration
      # Leave TELEGRAM_TOKEN empty for console mode
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN:-}
      - CHAT_ID=${CHAT_ID:-}
      - INTERVAL_MINUTES=${INTERVAL_MINUTES:-60}
    # Command line arguments for the application
    command: >
      sh -c "
        echo 'Debug: Checking configuration mode...';
        if [ ! -z \"$$TELEGRAM_TOKEN\" ]; then
          echo 'Debug: Running in Telegram mode';
          echo 'Debug: CHAT_ID is ' && if [ ! -z \"$$CHAT_ID\" ]; then echo 'set'; else echo 'not set'; fi;
          echo 'Debug: INTERVAL_MINUTES=' && echo \"$$INTERVAL_MINUTES\";
          dotnet ResourceMonitorCli.dll -t \"$$TELEGRAM_TOKEN\" -c \"$$CHAT_ID\" -i \"$$INTERVAL_MINUTES\";
        else
          echo 'Debug: Running in Console mode';
          dotnet ResourceMonitorCli.dll;
        fi
      "
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
